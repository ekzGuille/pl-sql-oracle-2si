-- Guillermo Sesé Santos

-- ENUNCIADO

  -- REQUERIMIENTOS

  -- Un cliente (puede ser una tienda) tiene cuentas. En caso de ser tienda, se aplica un 30% descuento
  -- Una cuenta puede estar a nombre de varios clientes
  -- Una cuenta bancaria esta asignada a una sucursal determinada de un banco
  -- El cliente tiene que tener saldo en su cuenta para poder gestionar el pedido
  -- Una venta se realiza sobre pedido
  -- Una venta supone una disminución del stock del articulo
  -- Los articulos están asignados a uno o varios fabricantes
  -- Los articulos tienen existencias en un almacen
  -- Si no hay existencias en el almacen, se deriva a una tienda con existencias (en caso de que el pedido NO sea de una tienda)
  -- En caso de no haber existencias en el almacen, se genera un pedido a los fabricantes (10 unidades a cada uno)
  -- Las tiendas tienen artículos asignados con su número de existencias
  -- Hay artículos en promoción con un 10%-20% de descuento
  -- Hay tiendas (franquicias) que pertenecen a otra tienda (tienda matriz). En caso de hacer un pedido a la matriz, se extiende a todas las tiendas que tiene asignadas, dividiendo el número de artículos proporcionalmente a cada franquicia

  -- FUNCIONALIDADES

  -- Objetos para introducir valores en todas las entidades generadas
  -- Procedimientos de CRUD para todas las entidades
  -- Funciones que permitan calcular descuentos, verificar saldos de cliente, existencias de articulos....
  -- Procedimientos que permitan realizar un pedido y ver el resultado del mismo (incluye importes y tienda(s) que realizarán el envío o excepciones en caso de error: cliente sin saldo, sin existencias....)


-- PUESTA EN MARCHA

CLEAR SCR 
DISCONNECT  
-- Conectarse como SYS y crear otro usuario
CONNECT SYS AS SYSDBA; 

DROP USER GUILLERMO; 

-- Usuario con el que trabajaremos
CREATE USER GUILLERMO IDENTIFIED BY Guillermo; 
GRANT DBA TO GUILLERMO; 
GRANT ALL PRIVILEGES TO GUILLERMO; 

-- Insertar las tablas del libro
-- Tablas a utilizar: ARTICULOS, TIENDAS, FABRICANTES, PEDIDOS, VENTAS, BANCOS, SUCURSALES, CUENTAS, CLIENTES,
-- Crear la tabla: ALMACEN asi como las tablas intermedias de las relaciones ternarias

-- TABLA ARTICULOS
DROP TABLE ARTICULOS CASCADE CONSTRAINTS;
CREATE TABLE ARTICULOS(
  ARTICULO       VARCHAR2(20),
  COD_FABRICANTE NUMBER(3),
  PESO           NUMBER(3),
  CATEGORIA      VARCHAR2(10),
  PRECIO_VENTA   NUMBER (6,2),
  PRECIO_COSTO   NUMBER (6,2),
  EXISTENCIAS    NUMBER (5),
  NIF            VARCHAR2(10),
  CONSTRAINT PK_ARTICULOS PRIMARY KEY (ARTICULO,COD_FABRICANTE,PESO,CATEGORIA),
  CONSTRAINT FK_ARTICULOS FOREIGN KEY (NIF) REFERENCES TIENDAS (NIF)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON ARTICULOS TO GUILLERMO;

INSERT INTO ARTICULOS VALUES ('Macarrones',20, 1, 'Primera',1, 0.98,120,'1111-A');

INSERT INTO ARTICULOS VALUES ('Tallarines',20, 2, 'Primera',1.20,1,100,'1111-A');

INSERT INTO ARTICULOS VALUES ('Tallarines',20, 1, 'Segunda',0.99,0.50,100,'4444-A');

INSERT INTO ARTICULOS VALUES ('Macarrones',20, 1, 'Tercera',0.80,0.50,100,'4444-A');

INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Primera',2,1.50,220,'1111-A');
INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Segunda',1.50,1,220,'3333-N');
INSERT INTO ARTICULOS VALUES ('Atún',10, 3, 'Tercera',1,0.50,220,'1111-A');
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1, 'Primera',2.5,2,200,'4444-A');
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1, 'Segunda',2,1.6,200,'4141-B');
INSERT INTO ARTICULOS VALUES ('Sardinillas',10, 1, 'Tercera',1,1.5,220,'4141-B');
INSERT INTO ARTICULOS VALUES ('Mejillones',10, 1, 'Tercera',1,0.9,200,'4444-A');
INSERT INTO ARTICULOS VALUES ('Mejillones',10, 1, 'Primera',3,2,300,'2222-A');

INSERT INTO ARTICULOS VALUES ('Macarrones',25, 1, 'Primera',1.5,1,150,'2222-A');
INSERT INTO ARTICULOS VALUES ('Tallarines',25, 1, 'Primera',1,0.90,100,'4141-B');
INSERT INTO ARTICULOS VALUES ('Fideos',25, 1, 'Segunda',0.75,0.50,100,'4141-B');
INSERT INTO ARTICULOS VALUES ('Fideos',25, 1, 'Primera',1,0.80,100,'2222-A');

INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Primera',2,1.8,100,'4444-A');
INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Segunda',1,0.8,100,'4444-A');
INSERT INTO ARTICULOS VALUES ('Galletas Cuadradas',15, 1, 'Tercera',0.50,0.40,100);
INSERT INTO ARTICULOS VALUES ('Barquillos',15, 1, 'Primera',1,0.80,100,'4141-B');
INSERT INTO ARTICULOS VALUES ('Barquillos',15, 1, 'Segunda',1,0.80,100,'4444-A');
INSERT INTO ARTICULOS VALUES ('Canutillos',15, 2, 'Primera',1.7,1.5,110,'4141-B');
INSERT INTO ARTICULOS VALUES ('Canutillos',15, 2, 'Segunda',1.2,1.5,110,'4444-A');

INSERT INTO ARTICULOS VALUES ('Leche entera',30, 1, 'Primera',1.1,1,300,'4141-B');
INSERT INTO ARTICULOS VALUES ('Leche desnat.',30, 1,'Primera',1.2,1,300,'4444-A');
INSERT INTO ARTICULOS VALUES ('Leche semi.',30, 1, 'Primera',1.30,1.10,300,'4141-B');
INSERT INTO ARTICULOS VALUES ('Leche entera',30, 2,'Primera',2.10,2,300,'4141-B');
INSERT INTO ARTICULOS VALUES ('Leche desnat.',30, 2, 'Primera',2.2,2,300,'2222-A');
INSERT INTO ARTICULOS VALUES ('Leche semi.',30, 2,  'Primera',2.3,2.1,300,'2222-A');
INSERT INTO ARTICULOS VALUES ('Mantequilla',30, 1, 'Primera',1.8,2,200,'2222-A');
INSERT INTO ARTICULOS VALUES ('Mantequilla',30, 1, 'Segunda',1.4,2,200,'2222-A');


-- TABLA TIENDAS
DROP TABLE TIENDAS CASCADE CONSTRAINTS;
CREATE TABLE TIENDAS(
  NIF       VARCHAR2(10),
  NOMBRE    VARCHAR2(20),
  DIRECCION VARCHAR2(20),
  POBLACION VARCHAR2(20),
  PROVINCIA VARCHAR2(20),
  CODPOSTAL NUMBER(5),
  CONSTRAINT PK_TIENDAS PRIMARY KEY (NIF)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON TIENDAS TO GUILLERMO;

INSERT INTO TIENDAS VALUES('1111-A','Almacenes Pérez', 'C/Toledo, 20',
 'Siguenza','GUADALAJARA',19104);
INSERT INTO TIENDAS VALUES('5555-B','La gacela', 'C/Santander Rios, 45',
 'Azuqueca','GUADALAJARA', 19209);
INSERT INTO TIENDAS VALUES('2222-A','Comestibles Rodolfo',
'C/ del Val s/n', 'Alcalá de Henares','MADRID',28804);
INSERT INTO TIENDAS VALUES('4444-A','La Pasta Gansa', 'C/Alcalá, 2',
 'Ajalvir','MADRID', 28765);
 INSERT INTO TIENDAS VALUES('3333-N','Ultramarinos Montse',
  'Avda. Pio 10', 'Toledo','TOLEDO',45100);
INSERT INTO TIENDAS VALUES('4141-B','Todo Toledo',
 'C/Avila 24', 'Talavera','TOLEDO',45199);


-- TABLA FABRICANTES
DROP TABLE FABRICANTES CASCADE CONSTRAINTS;
CREATE TABLE FABRICANTES(
  COD_FABRICANTE NUMBER(3),
  NOMBRE         VARCHAR2(15),
  PAIS           VARCHAR2(15),
  CONSTRAINT PK_FABRICANTES PRIMARY KEY (COD_FABRICANTE)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON FABRICANTES TO GUILLERMO;

INSERT INTO FABRICANTES VALUES(10,'CALVO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(15,'LU', 'BELGICA');
INSERT INTO FABRICANTES VALUES(20,'BARILLA', 'ITALIA');
INSERT INTO FABRICANTES VALUES(25,'GALLO', 'ESPAÑA');
INSERT INTO FABRICANTES VALUES(30,'PRESIDENT', 'FRANCIA');


-- TABLA PEDIDOS
DROP TABLE PEDIDOS CASCADE CONSTRAINTS;
CREATE TABLE PEDIDOS(
  NIF               VARCHAR2(10) NOT NULL,
  ARTICULO          VARCHAR2(20) NOT NULL,
  COD_FABRICANTE    NUMBER(3)    NOT NULL,
  PESO              NUMBER(3)    NOT NULL,
  CATEGORIA         VARCHAR2(10) NOT NULL,
  FECHA_PEDIDO      DATE         NOT NULL,
  UNIDADES_PEDIDAS  NUMBER(4),
  CONSTRAINT PK_PEDIDOS PRIMARY KEY (NIF, ARTICULO,COD_FABRICANTE,PESO,CATEGORIA,FECHA_PEDIDO)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON PEDIDOS TO GUILLERMO;

ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY';

INSERT INTO PEDIDOS VALUES ('5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('18/02/2006'), 30);
INSERT INTO PEDIDOS VALUES ('5555-B','Atún',10, 3, 'Primera',
TO_DATE('21/02/2006'), 10);
INSERT INTO PEDIDOS VALUES ('5555-B','Atún',10, 3, 'Segunda',
TO_DATE('11/03/2006'), 4);
INSERT INTO PEDIDOS VALUES ('5555-B','Sardinillas',10, 1, 'Segunda',
TO_DATE('11/03/2006'), 10);
INSERT INTO PEDIDOS VALUES ('5555-B','Macarrones',25, 1, 'Primera',
TO_DATE('14/04/2006'), 12);
INSERT INTO PEDIDOS VALUES ('5555-B','Fideos',25, 1, 'Segunda',
TO_DATE('18/05/2006'), 24);
INSERT INTO PEDIDOS VALUES ('5555-B','Fideos',25, 1, 'Segunda',
TO_DATE('19/05/2006'), 20);
INSERT INTO PEDIDOS VALUES ('5555-B','Galletas Cuadradas',
15, 1, 'Segunda', TO_DATE('20/06/2006'), 15);

INSERT INTO PEDIDOS VALUES ('1111-A','Barquillos',15, 1, 'Primera',
TO_DATE('20/02/2006'), 10);

INSERT INTO PEDIDOS VALUES ('1111-A','Canutillos',15, 2, 'Segunda',
TO_DATE('10/04/2006'), 12);
INSERT INTO PEDIDOS VALUES ('1111-A','Leche semi.',30, 1, 'Primera',
TO_DATE('24/06/2006'), 5);
INSERT INTO PEDIDOS VALUES ('1111-A','Leche semi.',30, 2, 'Primera',
TO_DATE('04/07/2006'), 11);
INSERT INTO PEDIDOS VALUES ('1111-A','Mantequilla',30, 1, 'Primera',
TO_DATE('10/07/2006'), 10);

INSERT INTO PEDIDOS VALUES ('4141-B','Macarrones',20, 1, 'Primera',
TO_DATE('16/04/2006'), 30);
INSERT INTO PEDIDOS VALUES ('4141-B','Atún',10, 3, 'Primera',
TO_DATE('21/06/2006'), 10);
INSERT INTO PEDIDOS VALUES ('4141-B','Atún',10, 3, 'Segunda',
TO_DATE('12/08/2006'), 9);


INSERT INTO PEDIDOS VALUES ('2222-A','Sardinillas',10, 1,
 'Segunda', TO_DATE('12/08/2006'),20);
INSERT INTO PEDIDOS VALUES ('2222-A','Sardinillas',10, 1,
'Tercera', TO_DATE('12/08/2006'),22);
INSERT INTO PEDIDOS VALUES('2222-A','Mejillones',10,1,
 'Primera',SYSDATE,1000);

INSERT INTO PEDIDOS VALUES ('3333-A','Macarrones',25, 1,
 'Primera',TO_DATE('10/11/2006'),8);
INSERT INTO PEDIDOS VALUES ('3333-A','Tallarines',25, 1,
'Primera', TO_DATE('12/11/2006'),9);
 INSERT INTO PEDIDOS VALUES ('3333-A','Fideos',25, 1,
'Primera', TO_DATE('15/11/2006'),11);
 INSERT INTO PEDIDOS VALUES ('3333-A','Galletas Cuadradas',
15, 1, 'Primera', TO_DATE('20/11/2006'),6);
INSERT INTO PEDIDOS VALUES ('3333-A','Barquillos',15, 1,
'Segunda', TO_DATE('20/11/2006'),40);
 INSERT INTO PEDIDOS VALUES ('3333-A','Canutillos',15, 2,
'Segunda', TO_DATE('20/11/2006'),10);


-- TABLA VENTAS
DROP TABLE VENTAS CASCADE CONSTRAINTS;
CREATE TABLE VENTAS(
  NIF                VARCHAR2(10),
  ARTICULO           VARCHAR2(20),
  COD_FABRICANTE     NUMBER(3),
  PESO               NUMBER(3),
  CATEGORIA          VARCHAR2(10),
  FECHA_VENTA        DATE          NOT NULL,
  UNIDADES_VENDIDAS  NUMBER(4),
  CONSTRAINT PK_VENTAS PRIMARY KEY (NIF,ARTICULO,COD_FABRICANTE,PESO,CATEGORIA,FECHA_VENTA)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON VENTAS TO GUILLERMO;

INSERT INTO VENTAS VALUES ('5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('19/02/2006'), 5);
INSERT INTO VENTAS VALUES ('5555-B','Atún',10, 3, 'Primera',
TO_DATE('19/02/2006'), 6);
INSERT INTO VENTAS VALUES ('5555-B','Atún',10, 3, 'Segunda',
TO_DATE('20/03/2006'), 15);
INSERT INTO VENTAS VALUES ('5555-B','Sardinillas',10, 1, 'Segunda',
TO_DATE('20/03/2006'), 8);
INSERT INTO VENTAS VALUES ('5555-B','Macarrones',25, 1, 'Primera',
TO_DATE('17/04/2006'), 2);
INSERT INTO VENTAS VALUES ('5555-B','Fideos',25, 1, 'Segunda',
TO_DATE('18/05/2006'), 14);
INSERT INTO VENTAS VALUES ('5555-B','Leche semi.',30, 1, 'Primera',
TO_DATE('24/06/2006'), 5);

INSERT INTO VENTAS VALUES ('2222-A','Galletas Cuadradas',
15, 1, 'Segunda', TO_DATE('20/06/2006'), 5);
INSERT INTO VENTAS VALUES ('2222-A','Barquillos',15, 1, 'Primera',
TO_DATE('20/02/2006'), 6);
INSERT INTO VENTAS VALUES ('2222-A','Canutillos',15, 2, 'Segunda',
TO_DATE('10/06/2006'), 2);
INSERT INTO VENTAS VALUES ('2222-A','Sardinillas',10, 1,
 'Segunda', TO_DATE('15/08/2006'),5);
INSERT INTO VENTAS VALUES ('2222-A','Sardinillas',10, 1,
'Tercera', TO_DATE('15/08/2006'),5);


INSERT INTO VENTAS VALUES ('3333-A','Leche semi.',30, 2, 'Primera',
TO_DATE('06/07/2006'), 11);
INSERT INTO VENTAS VALUES ('3333-A','Mantequilla',30, 1, 'Primera',
TO_DATE('16/07/2006'), 10);
INSERT INTO VENTAS VALUES ('3333-A','Macarrones',20, 1, 'Primera',
TO_DATE('26/04/2006'), 30);
INSERT INTO VENTAS VALUES ('3333-A','Atún',10, 3, 'Primera',
TO_DATE('26/04/2006'), 10);
INSERT INTO VENTAS VALUES ('3333-A','Barquillos',15, 1,
'Segunda', TO_DATE('25/11/2006'),4);
 INSERT INTO VENTAS VALUES ('3333-A','Canutillos',15, 2,
'Segunda', TO_DATE('25/11/2006'),4);

INSERT INTO VENTAS VALUES ('4141-B','Atún',10, 3, 'Segunda',
TO_DATE('12/08/2006'), 2);

INSERT INTO VENTAS VALUES ('4141-B','Macarrones',25, 1,
 'Primera',TO_DATE('10/11/2006'),2);
INSERT INTO VENTAS VALUES ('4141-B','Tallarines',25, 1,
'Primera', TO_DATE('11/11/2006'),3);
INSERT INTO VENTAS VALUES ('4141-B','Canutillos',15, 2,
'Segunda', TO_DATE('11/11/2006'),8);


-- TABLA BANCOS
DROP TABLE BANCOS CASCADE CONSTRAINTS;
CREATE TABLE   BANCOS(
  COD_BANCO   NUMBER(4) NOT NULL,
  NF_BANCO    VARCHAR2(10),
  NOMBRE_BANC VARCHAR2(30),
  DOM_FISCAL  VARCHAR(35),
  POBLACION   VARCHAR(35),
  CONSTRAINT PK_BANCOS PRIMARY KEY (COD_BANCO)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON BANCOS TO GUILLERMO;

INSERT INTO BANCOS VALUES(1111,'122322223','BANCO DE ESPAÑA','GRAN VIA','MADRID');
INSERT INTO BANCOS VALUES(1112,'222322223','BANCO DE GUADALAJARA','MAYOR',
					'GUADALAJARA');
INSERT INTO BANCOS VALUES(1113,'322322223','BANCO POPULAR','LA PLAZA','TOLEDO');
INSERT INTO BANCOS VALUES(1114,'422322223','CAJA CM','RIO DULCE','ALBACETE');

-- TABLA SUCURSALES
DROP TABLE SUCURSALES CASCADE CONSTRAINTS;
CREATE TABLE  SUCURSALES(
  COD_BANCO   NUMBER(4),
  COD_SUCUR   NUMBER (4),
  NOMBRE_SUC  VARCHAR2(35),
  DIREC_SUC   VARCHAR2(35),
  LOC_SUC     VARCHAR2(20),
  PROV_SUC    VARCHAR2(20),
  CONSTRAINT PK_SUCURSALES PRIMARY KEY (COD_BANCO,COD_SUCUR)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON SUCURSALES TO GUILLERMO;

INSERT INTO SUCURSALES VALUES(1111, 5000,'* SUCURSAL 1*', 'ANCHA 24',
	'TOLEDO','TOLEDO');
INSERT INTO SUCURSALES VALUES(1111, 5001,'* SUCURSAL 2*', 'PILON 33',
 'PASTRANA','GUADALAJARA');

INSERT INTO SUCURSALES VALUES(1112, 6000,'* SUCURSAL 6000*', 'MAYOR 55',
 'ALCALA','ALCALA');

INSERT INTO SUCURSALES VALUES(1113, 4000,'* SUCURSAL 4000*', 'ERAS 77',
 'ARANJUEZ','MADRID');


-- TABLA CUENTAS
DROP TABLE CUENTAS CASCADE CONSTRAINTS;
CREATE TABLE   CUENTAS(
  COD_BANCO   NUMBER(4),
  COD_SUCUR   NUMBER(4),
  NUM_CTA     NUMBER(10) ,
  FECHA_ALTA  DATE,
  NOMBRE_CTA  VARCHAR2(35),
  DIREC_CTA   VARCHAR2(35),
  POBLA_CTA   VARCHAR2(20),
  SALDO_DEBE  NUMBER(10),
  SALDO_HABER NUMBER(10),
  CONSTRAINT PK_CUENTAS PRIMARY KEY (COD_BANCO,COD_SUCUR,NUM_CTA)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON CUENTAS TO GUILLERMO;

INSERT INTO CUENTAS VALUES(1111, 5000,123456789,SYSDATE -7, 'JUAN','TOLEDO',
		'TOLEDO', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5000,123456788,SYSDATE -6, 'PEDRO','TOLEDO',
		'TOLEDO', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5001,123456787,SYSDATE -100, 'ANA','GUADALAJARA',
		'GUADALAJARA', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5001,123456786,SYSDATE -6, 'MANUEL','GUADALAJARA',
		'GUADALAJARA', 0,0);

INSERT INTO CUENTAS VALUES(1111, 5001,123456785,SYSDATE -230, 'ANDRES','ALCALA',
		'ALCALA', 0,0);

INSERT INTO CUENTAS VALUES(1112, 6000,33334444, SYSDATE,'ISABEL','MADRID',
		'MADRID', 0,0);
INSERT INTO CUENTAS VALUES(1112, 6000,33334440, SYSDATE-140,'MARIA','MADRID',
		'MADRID', 0,0);


-- TABLA CLIENTES
DROP TABLE CLIENTES CASCADE CONSTRAINTS;
CREATE TABLE CLIENTES (
  NIF       VARCHAR2(10) NOT NULL,
  NOMBRE    VARCHAR(14),
  LOCALIDAD VARCHAR(14),
  CONSTRAINT PK_CLIENTES PRIMARY KEY (NIF)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON CLIENTES TO GUILLERMO;

INSERT INTO CLIENTES VALUES ('7114B','JUAN GÓMEZ','SEVILLA');
INSERT INTO CLIENTES VALUES ('7871A','PEDRO GARCÍA','MADRID');
INSERT INTO CLIENTES VALUES ('9871H','JULIA MENA','BARCELONA');
INSERT INTO CLIENTES VALUES ('8554L','ROSA MUÑOZ','BILBAO');
INSERT INTO CLIENTES VALUES ('5554M','PEPA LÓPEZ','BILBAO');
INSERT INTO CLIENTES VALUES ('4554J','PEPE PINTO','TOLEDO');
INSERT INTO CLIENTES VALUES ('4675J','ALBERT MUNT','MADRID');


-- TABLA ALMACEN
DROP TABLE ALMACEN CASCADE CONSTRAINTS;
CREATE TABLE ALMACEN (
  ID_ALMACEN    NUMBER(4),
  DESC_ALMACEN  VARCHAR2(20),
  CONSTRAINT PK_ALMACEN PRIMARY KEY (ID_ALMACEN),
);

GRANT SELECT, INSERT, UPDATE, DELETE ON ALMACEN TO GUILLERMO;

INSERT INTO ALMACEN VALUES (1231,'ALMACENES PEREZ');
INSERT INTO ALMACEN VALUES (1211,'ALMACENES GUTIERREZ');
INSERT INTO ALMACEN VALUES (1331,'ALMACENES LANGA');
INSERT INTO ALMACEN VALUES (4431,'ALMACENES ESPELETA');


-- CREACION DE TABLAS INTERMEDIAS

-- TABLA PEDIDOS_VENTAS
DROP TABLE PEDIDOS_VENTAS CASCADE CONSTRAINTS;
CREATE TABLE PEDIDOS_VENTAS(
  NIF_V               VARCHAR2(10),
  ARTICULO_V          VARCHAR2(20),
  COD_FABRICANTE_V    NUMBER(3),
  PESO_V              NUMBER(3),
  CATEGORIA_V         VARCHAR2(10),
  FECHA_VENTA_V       DATE         NOT NULL,
  NIF_P               VARCHAR2(10) NOT NULL,
  ARTICULO_P          VARCHAR2(20) NOT NULL,
  COD_FABRICANTE_P    NUMBER(3)    NOT NULL,
  PESO_P              NUMBER(3)    NOT NULL,
  CATEGORIA_P         VARCHAR2(10) NOT NULL,
  FECHA_PEDIDO_P      DATE         NOT NULL,
  CONSTRAINT PK_PEDIDOS_VENTAS PRIMARY KEY (NIF_P, ARTICULO_P,COD_FABRICANTE_P,PESO_P,CATEGORIA_P,FECHA_PEDIDO_P, NIF_V,ARTICULO_V,COD_FABRICANTE_V,PESO_V,CATEGORIA_V,FECHA_VENTA_V),
  CONSTRAINT FK_PEDIDOS FOREIGN KEY (NIF_P, ARTICULO_P,COD_FABRICANTE_P,PESO_P,CATEGORIA_P,FECHA_PEDIDO_P) REFERENCES PEDIDOS (NIF, ARTICULO,COD_FABRICANTE,PESO,CATEGORIA,FECHA_PEDIDO),
  CONSTRAINT FK_VENTAS FOREIGN KEY (NIF_V,ARTICULO_V,COD_FABRICANTE_V,PESO_V,CATEGORIA_V,FECHA_VENTA_V) REFERENCES VENTAS (NIF, ARTICULO,COD_FABRICANTE,PESO,CATEGORIA,FECHA_PEDIDO),
);

GRANT SELECT, INSERT, UPDATE, DELETE ON PEDIDOS_VENTAS TO GUILLERMO;

INSERT INTO PEDIDOS_VENTAS VALUES('5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('18/02/2006'),'5555-B','Macarrones',20, 1, 'Primera',
TO_DATE('19/02/2006'));

INSERT INTO PEDIDOS_VENTAS VALUES('5555-B','Atún',10, 3, 'Primera',
TO_DATE('21/02/2006'),'2222-A','Sardinillas',10, 1,
 'Segunda', TO_DATE('15/08/2006'));

INSERT INTO PEDIDOS_VENTAS VALUES('5555-B','Galletas Cuadradas',
15, 1, 'Segunda', TO_DATE('20/06/2006'),'4141-B','Macarrones',25, 1,
 'Primera',TO_DATE('10/11/2006'));

INSERT INTO PEDIDOS_VENTAS VALUES('1111-A','Mantequilla',30, 1, 'Primera',
TO_DATE('10/07/2006'),'4141-B','Canutillos',15, 2,
'Segunda', TO_DATE('11/11/2006'));

-- TABLA CLIENTES_CUENTAS
DROP TABLE CLIENTES_CUENTAS CASCADE CONSTRAINTS;
CREATE TABLE CLIENTES_CUENTAS(
  NIF         VARCHAR2(10) NOT NULL,
  NUM_CTA     NUMBER(10),
  CONSTRAINT PK_CLIENTES_CUENTA PRIMARY KEY (NIF,COD_BANCO,NUM_CTA),
  CONSTRAINT FK_CLIENTES FOREIGN KEY (NIF) REFERENCES CLIENTES (NIF),
  CONSTRAINT FK_CUENTA FOREIGN KEY (NUM_CTA) REFERENCES CUENTA (NUM_CTA)
);

GRANT SELECT, INSERT, UPDATE, DELETE ON CLIENTES_CUENTAS TO GUILLERMO;

INSERT INTO CLIENTES_CUENTAS VALUES('7114B',123456789);
INSERT INTO CLIENTES_CUENTAS VALUES('7871A',123456787);
INSERT INTO CLIENTES_CUENTAS VALUES('8554L',33334444);
INSERT INTO CLIENTES_CUENTAS VALUES('4554J',123456785);
INSERT INTO CLIENTES_CUENTAS VALUES('4675J',33334440);

-- TABLA ALMACEN_FABRICANTES
DROP TABLE ALMACEN_FABRICANTES CASCADE CONSTRAINTS;
CREATE TABLE ALMACEN_FABRICANTES(
  ID_ALMACEN NUMBER(4),
  COD_FABRICANTE NUMBER(3),
  CONSTRAINT PK_ID_ALMACEN_ALMACEN_FAB PRIMARY KEY (ID_ALMACEN),
  CONSTRAINT PK_FABRICANTES_ALMCAEN_FAB PRIMARY KEY (COD_FABRICANTE),
  CONSTRAINT PK_ID_ALMACEN_ALMACEN_FAB PRIMARY KEY (ID_ALMACEN),
  CONSTRAINT PK_FABRICANTES_ALMCAEN_FAB PRIMARY KEY (COD_FABRICANTE),

);

GRANT SELECT, INSERT, UPDATE, DELETE ON ALMACEN_FABRICANTES TO GUILLERMO;

INSERT INTO ALMACEN_FABRICANTES VALUES(1211,20);
INSERT INTO ALMACEN_FABRICANTES VALUES(1331,10);
INSERT INTO ALMACEN_FABRICANTES VALUES(4431,30);

/*
-- CREAR TABLAS DESDE OBJETOS

CREATE TYPE NOMBRE_OBJECTO AS OBJECT (
  ID_OBJECTO  NUMBER(2) NOT NULL;
  DESC_OBJETO VARCHAR2(30) NOT NULL
);

CREATE TABLE TABLA_OBJETO OF NOMBRE_OBJETO;
-- PONER AQUI LAS CONSTRAINTS DE LAS PK Y FK
*/

-- FUNCIONES

CREATE OR REPLACE FUNCTION APLICAR_DESCUENTO(PRECIO_INI NUMBER, DESCUENTO NUMBER) RETURN NUMBER
AS
  v_precio_fin NUMBER;
BEGIN
  v_precio_fin := PRECIO_INI * (100 - DESCUENTO);
  RETURN v_precio_fin;
END APLICAR_DESCUENTO;
/

CREATE OR REPLACE FUNCTION TIENE_SALDO(ID_CLIENTE NUMBER) RETURN NUMBER
AS
  v_saldo NUMBER DEFAULT 0;
BEGIN
  SELECT CUENTAS.SALDO_HABER INTO v_saldo
    FROM CUENTAS, CLIENTES_CUENTAS, CLIENTES 
    WHERE CUENTAS.NUM_CTA = CLIENTES_CUENTAS.NUM_CTA
      AND CLIENTES_CUENTAS.NIF = CLIENTES.NIF 
      AND CLIENTES.NIF = ID_CLIENTE;
  RETURN v_saldo;
END TIENE_SALDO;
/

CREATE OR REPLACE FUNCTION HAY_ARTICULOS(ID_ARTICULO NUMBER) RETURN NUMBER
AS 
  v_cantidad_articulos NUMBER DEFAULT 0;
BEGIN
  SELECT ARTICULOS.EXISTENCIAS INTO v_cantidad_articulos
    FROM ARTICULOS
    WHERE ARTICULOS.ARTICULO = ID_ARTICULO;
  RETURN v_cantidad_articulos;
END HAY_ARTICULOS;
/


-- OBJETOS CORRESPONDIENTES A LAS TABLAS

-- Crear la tabla: ALMACEN asi como las tablas intermedias de las relaciones ternarias
CREATE OR REPLACE TYPE ARTICULOS_OBJ AS OBJECT (
  ARTICULO       VARCHAR2(20),
  COD_FABRICANTE NUMBER(3),
  PESO           NUMBER(3),
  CATEGORIA      VARCHAR2(10),
  PRECIO_VENTA   NUMBER (6,2),
  PRECIO_COSTO   NUMBER (6,2),
  EXISTENCIAS    NUMBER (5),
  NIF            VARCHAR2(10)
)

CREATE OR REPLACE TYPE TIENDAS_OBJ AS OBJECT(
  NIF       VARCHAR2(10),
  NOMBRE    VARCHAR2(20),
  DIRECCION VARCHAR2(20),
  POBLACION VARCHAR2(20),
  PROVINCIA VARCHAR2(20),
  CODPOSTAL NUMBER(5)
);

CREATE OR REPLACE TYPE FABRICANTES_OBJ AS OBJECT(
  COD_FABRICANTE NUMBER(3),
  NOMBRE         VARCHAR2(15),
  PAIS           VARCHAR2(15)
);

CREATE OR REPLACE TYPE PEDIDOS_OBJ AS OBJECT(
  NIF               VARCHAR2(10) NOT NULL,
  ARTICULO          VARCHAR2(20) NOT NULL,
  COD_FABRICANTE    NUMBER(3)    NOT NULL,
  PESO              NUMBER(3)    NOT NULL,
  CATEGORIA         VARCHAR2(10) NOT NULL,
  FECHA_PEDIDO      DATE         NOT NULL,
  UNIDADES_PEDIDAS  NUMBER(4)
);

CREATE OR REPLACE TYPE VENTAS_OBJ AS OBJECT(
  NIF                VARCHAR2(10),
  ARTICULO           VARCHAR2(20),
  COD_FABRICANTE     NUMBER(3),
  PESO               NUMBER(3),
  CATEGORIA          VARCHAR2(10),
  FECHA_VENTA        DATE          NOT NULL,
  UNIDADES_VENDIDAS  NUMBER(4)
);

CREATE OR REPLACE TYPE BANCOS_OBJ AS OBJECT(  
  COD_BANCO   NUMBER(4)     NOT NULL,
  NF_BANCO    VARCHAR2(10),
  NOMBRE_BANC VARCHAR2(30),
  DOM_FISCAL  VARCHAR(35),
  POBLACION   VARCHAR(35)
);

CREATE OR REPLACE TYPE SUCURSALES_OBJ AS OBJECT(
  COD_BANCO   NUMBER(4),
  COD_SUCUR   NUMBER (4),
  NOMBRE_SUC  VARCHAR2(35),
  DIREC_SUC   VARCHAR2(35),
  LOC_SUC     VARCHAR2(20),
  PROV_SUC    VARCHAR2(20)
);

CREATE OR REPLACE TYPE CUENTAS_OBJ AS OBJECT(
  COD_BANCO   NUMBER(4),
  COD_SUCUR   NUMBER(4),
  NUM_CTA     NUMBER(10) ,
  FECHA_ALTA  DATE,
  NOMBRE_CTA  VARCHAR2(35),
  DIREC_CTA   VARCHAR2(35),
  POBLA_CTA   VARCHAR2(20),
  SALDO_DEBE  NUMBER(10),
  SALDO_HABER NUMBER(10)
);

CREATE OR REPLACE TYPE CLIENTES_OBJ AS OBJECT(
  NIF       VARCHAR2(10) NOT NULL,
  NOMBRE    VARCHAR(14),
  LOCALIDAD VARCHAR(14)
);

CREATE OR REPLACE TYPE ALMACEN_OBJ AS OBJECT(
  ID_ALMACEN    NUMBER(4),
  DESC_ALMACEN  VARCHAR2(20)
);

CREATE OR REPLACE TYPE PEDIDOS_VENTAS_OBJ AS OBJECT(
  NIF_V               VARCHAR2(10),
  ARTICULO_V          VARCHAR2(20),
  COD_FABRICANTE_V    NUMBER(3),
  PESO_V              NUMBER(3),
  CATEGORIA_V         VARCHAR2(10),
  FECHA_VENTA_V       DATE         NOT NULL,
  NIF_P               VARCHAR2(10) NOT NULL,
  ARTICULO_P          VARCHAR2(20) NOT NULL,
  COD_FABRICANTE_P    NUMBER(3)    NOT NULL,
  PESO_P              NUMBER(3)    NOT NULL,
  CATEGORIA_P         VARCHAR2(10) NOT NULL,
  FECHA_PEDIDO_P      DATE         NOT NULL
);

CREATE OR REPLACE TYPE CLIENTES_CUENTAS_OBJ AS OBJECT(
  NIF         VARCHAR2(10) NOT NULL,
  NUM_CTA     NUMBER(10)
);

CREATE OR REPLACE TYPE ALMACEN_FABRICANTES_OBJ AS OBJECT(
  ID_ALMACEN NUMBER(4),
  COD_FABRICANTE NUMBER(3)
);



